# Phase 7: Suggestion Creation - Implementation Plan

**Created:** 2026-02-12
**Phase:** 7 of 10
**Timeline:** Week 6
**Companion Document:** [Phase 7 Roadmap](./2026-02-12_phase-7_suggestion-creation-roadmap.md)

---

## Project Principles

‚ö†Ô∏è **Calendar events must be tentative and clearly marked as suggestions.** Users need to accept/decline.

---

## Phase Overview

**Goal:** Insert matched suggestions as calendar events in both partners' Google Calendars

**Key deliverables:**
- Function to create calendar events via API
- Event formatting per specifications
- Create in both calendars
- Log suggestions to suggestions.json
- Return calendar links

---

## Technical Specifications

### 1. Calendar Event Creation

**Add to:** `server/services/calendar.js`

```javascript
async function createSuggestionEvent(coupleId, suggestion) {
  const authService = require('./auth');
  const { google } = require('googleapis');

  // Get tokens for both partners
  const partner1Tokens = authService.getStoredTokens(coupleId, 'partner1');
  const partner2Tokens = authService.getStoredTokens(coupleId, 'partner2');

  if (!partner1Tokens || !partner2Tokens) {
    throw new Error('Both partners must be authenticated');
  }

  // Format event per architecture.md
  const event = {
    summary: `Suggested: ${suggestion.activity.name}`,
    description: formatEventDescription(suggestion),
    location: suggestion.activity.location.address,
    start: {
      dateTime: suggestion.suggestedStart,
      timeZone: 'America/Chicago' // Or detect from location
    },
    end: {
      dateTime: suggestion.suggestedEnd,
      timeZone: 'America/Chicago'
    },
    transparency: 'tentative', // Shows as tentative in calendar
    colorId: '11' // Optional: red for suggestions
  };

  // Create in Partner 1's calendar
  const oauth2Client1 = new google.auth.OAuth2();
  oauth2Client1.setCredentials(partner1Tokens);
  const calendar1 = google.calendar({ version: 'v3', auth: oauth2Client1 });

  const event1Response = await calendar1.events.insert({
    calendarId: 'primary',
    resource: event
  });

  // Create in Partner 2's calendar
  const oauth2Client2 = new google.auth.OAuth2();
  oauth2Client2.setCredentials(partner2Tokens);
  const calendar2 = google.calendar({ version: 'v3', auth: oauth2Client2 });

  const event2Response = await calendar2.events.insert({
    calendarId: 'primary',
    resource: event
  });

  return {
    partner1EventId: event1Response.data.id,
    partner1EventLink: event1Response.data.htmlLink,
    partner2EventId: event2Response.data.id,
    partner2EventLink: event2Response.data.htmlLink
  };
}

function formatEventDescription(suggestion) {
  return `
üéØ Suggested Activity

What: ${suggestion.activity.description}

Why: ${suggestion.matchReasons}

Details:
- Duration: ${suggestion.activity.duration} minutes
- Price: ${suggestion.activity.price} (~$${suggestion.activity.priceAmount})
- Location: ${suggestion.activity.location.name}

More info: ${suggestion.activity.url}

---
To accept: Keep this event
To decline: Delete this event

Generated by Calendar Concierge
  `.trim();
}
```

---

### 2. Suggestion Logging

**File:** `server/data/suggestions.json`

```json
[
  {
    "id": "sugg-1",
    "coupleId": "couple-1",
    "activityId": "act-1",
    "activityName": "Beginner Pottery Workshop",
    "suggestedTime": {
      "start": "2026-02-22T14:00:00-06:00",
      "end": "2026-02-22T17:00:00-06:00"
    },
    "matchReason": "Matches your interest in arts and your want-to-try item: pottery class",
    "matchScore": 18,
    "status": "sent",
    "calendarEventIds": {
      "partner1": "event123abc",
      "partner2": "event456def"
    },
    "calendarLinks": {
      "partner1": "https://calendar.google.com/event?eid=...",
      "partner2": "https://calendar.google.com/event?eid=..."
    },
    "createdAt": "2026-02-12T10:00:00Z"
  }
]
```

**Logging function:**

```javascript
async function logSuggestion(coupleId, suggestion, calendarEventIds, calendarLinks) {
  const fs = require('fs').promises;
  const path = require('path');

  const SUGGESTIONS_FILE = path.join(__dirname, '../data/suggestions.json');

  // Load existing suggestions
  let suggestions = [];
  try {
    const data = await fs.readFile(SUGGESTIONS_FILE, 'utf8');
    suggestions = JSON.parse(data);
  } catch (error) {
    if (error.code !== 'ENOENT') throw error;
  }

  // Create suggestion record
  const suggestionRecord = {
    id: `sugg-${Date.now()}`,
    coupleId,
    activityId: suggestion.activity.id,
    activityName: suggestion.activity.name,
    suggestedTime: {
      start: suggestion.suggestedStart,
      end: suggestion.suggestedEnd
    },
    matchReason: suggestion.matchReasons,
    matchScore: suggestion.score,
    status: 'sent',
    calendarEventIds,
    calendarLinks,
    createdAt: new Date().toISOString()
  };

  suggestions.push(suggestionRecord);

  // Save
  await fs.writeFile(SUGGESTIONS_FILE, JSON.stringify(suggestions, null, 2));

  return suggestionRecord;
}
```

---

### 3. Integration with Matching Service

**Update:** `server/services/matching.js`

```javascript
async function generateSuggestions(coupleId) {
  // ... existing matching logic ...

  // Create calendar events for top suggestions
  const createdSuggestions = [];

  for (const suggestion of suggestions.slice(0, 2)) {
    try {
      // Create in both calendars
      const calendarEvents = await calendarService.createSuggestionEvent(
        coupleId,
        suggestion
      );

      // Log suggestion
      const logged = await logSuggestion(
        coupleId,
        suggestion,
        {
          partner1: calendarEvents.partner1EventId,
          partner2: calendarEvents.partner2EventId
        },
        {
          partner1: calendarEvents.partner1EventLink,
          partner2: calendarEvents.partner2EventLink
        }
      );

      createdSuggestions.push({
        ...suggestion,
        calendarEventIds: logged.calendarEventIds,
        calendarLinks: logged.calendarLinks
      });
    } catch (error) {
      console.error('Failed to create suggestion:', error);
      // Continue with remaining suggestions
    }
  }

  return {
    success: true,
    freeWindows,
    matchedActivities: scoredActivities,
    suggestions: createdSuggestions
  };
}
```

---

### 4. Event Format Specification

**Per architecture.md:**

**Title:** `Suggested: [Activity Name]`

**Description format:**
```
üéØ Suggested Activity

What: [Activity description]

Why: [Match reasons]

Details:
- Duration: X minutes
- Price: $ (~$XX)
- Location: [Venue name]

More info: [URL]

---
To accept: Keep this event
To decline: Delete this event
```

**Properties:**
- `transparency: 'tentative'` ‚Üí Shows as tentative in calendar
- Optional: `colorId: '11'` ‚Üí Red color for visibility
- Location set to venue address
- Start/end times from time window

---

## Testing Criteria

- [ ] Can create event via Google Calendar API
- [ ] Event appears in Partner 1 calendar
- [ ] Event appears in Partner 2 calendar
- [ ] Event shows as tentative
- [ ] Description formatted correctly
- [ ] Match reason included
- [ ] Calendar links work
- [ ] Suggestion logged to suggestions.json
- [ ] Works for multiple suggestions

---

## Next Steps

After Phase 7:
- Verify events appear in Google Calendar
- Check both web and mobile views
- Move to [Phase 8: Admin Dashboard](./2026-02-12_phase-8_admin-dashboard-plan.md)

**Phase 7 complete when:** Suggestions successfully created in both calendars.

---

**Reference Documents:**
- [High-Level Plan](./2026-02-12_high-level_mvp-implementation-plan.md)
- [Architecture](../../aiDocs/architecture.md)
- [Phase 7 Roadmap](./2026-02-12_phase-7_suggestion-creation-roadmap.md)
- [Google Calendar API](https://developers.google.com/workspace/calendar/api/v3/reference/events/insert)
